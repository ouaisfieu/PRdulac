<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="color-scheme" content="dark light"/>
  <title>Dossier — Media Live (offline, sans CDN)</title>
  <meta name="description" content="Dossier documentaire statique : flux live, pièces jointes, embeds, recherche et indexation locale."/>
  <style>
    :root{
      --bg:#07090f; --bg2:#0b1020; --panel:#0e1428cc; --panel2:#0f1830;
      --text:#e8ecff; --muted:#a9b3d6; --faint:#7e89b6; --line:#1e2a55;
      --accent:#7c5cff; --accent2:#32d6ff; --good:#3df0a8; --warn:#ffcc66; --bad:#ff5c7a;
      --shadow:0 18px 70px rgba(0,0,0,.45);
      --radius:18px; --radius2:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f9ff; --bg2:#eef2ff; --panel:#ffffffd9; --panel2:#ffffff;
        --text:#0a1024; --muted:#34406a; --faint:#5b6795; --line:#d6dcff;
        --shadow:0 18px 60px rgba(10,16,36,.15);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 600px at 110% 15%, rgba(50,214,255,.20), transparent 55%),
        radial-gradient(900px 600px at 40% 110%, rgba(61,240,168,.12), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{display:grid;grid-template-columns:360px 1fr 420px;gap:14px;padding:14px;max-width:1600px;margin:0 auto}
    @media (max-width:1200px){.wrap{grid-template-columns:1fr;padding:12px}.col{min-height:auto}}
    .topbar{position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(8,10,18,.75),rgba(8,10,18,.35));border-bottom:1px solid rgba(255,255,255,.08)}
    @media (prefers-color-scheme: light){.topbar{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.55));border-bottom:1px solid rgba(10,16,36,.08)}}
    .topbar-inner{max-width:1600px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:12px 14px}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .logo{width:40px;height:40px;border-radius:14px;background:radial-gradient(16px 16px at 30% 30%,rgba(255,255,255,.35),transparent 60%),conic-gradient(from 180deg,var(--accent),var(--accent2),var(--good),var(--accent));box-shadow:0 12px 40px rgba(124,92,255,.22);position:relative;border:1px solid rgba(255,255,255,.12)}
    .logo:after{content:"";position:absolute;inset:9px;border-radius:12px;background:rgba(10,14,26,.35);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(8px)}
    @media (prefers-color-scheme: light){.logo:after{background:rgba(255,255,255,.45)}}
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
    @media (prefers-color-scheme: light){.pill{border:1px solid rgba(10,16,36,.12);background:rgba(10,16,36,.04)}}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--good);box-shadow:0 0 0 3px rgba(61,240,168,.18)}
    .search{flex:1;display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);box-shadow:0 12px 50px rgba(0,0,0,.18)}
    @media (prefers-color-scheme: light){.search{border:1px solid rgba(10,16,36,.12);background:rgba(255,255,255,.65)}}
    .search input{width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:13px}
    .search kbd{font-family:var(--mono);font-size:11px;color:var(--faint);padding:4px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.15)}
    @media (prefers-color-scheme: light){.search kbd{background:rgba(10,16,36,.06);border:1px solid rgba(10,16,36,.10)}}
    .btn{cursor:pointer;border:none;outline:none;color:var(--text);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px 12px;font-size:12px;display:inline-flex;gap:8px;align-items:center;transition:transform .08s ease,background .15s ease,border-color .15s ease;user-select:none}
    @media (prefers-color-scheme: light){.btn{background:rgba(255,255,255,.65);border:1px solid rgba(10,16,36,.12)}}
    .btn:hover{transform:translateY(-1px);border-color:rgba(124,92,255,.55)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(135deg,rgba(124,92,255,.24),rgba(50,214,255,.18));border-color:rgba(124,92,255,.55);box-shadow:0 18px 60px rgba(124,92,255,.16)}
    .btn.danger{border-color:rgba(255,92,122,.45)}
    .col{min-height:70vh}
    .card{border-radius:var(--radius2);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);overflow:hidden}
    @media (prefers-color-scheme: light){.card{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));border:1px solid rgba(10,16,36,.10)}}
    .card .hd{padding:14px 14px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border-bottom:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,rgba(255,255,255,.06),transparent)}
    @media (prefers-color-scheme: light){.card .hd{border-bottom:1px solid rgba(10,16,36,.08);background:linear-gradient(180deg,rgba(10,16,36,.03),transparent)}}
    .title{display:flex;flex-direction:column;gap:4px;min-width:0}
    .title h2{margin:0;font-size:13px;letter-spacing:.15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title p{margin:0;font-size:12px;color:var(--muted);line-height:1.25rem}
    .card .bd{padding:12px 14px 14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:1200px){.grid2{grid-template-columns:1fr}}
    .mini{border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);padding:10px}
    @media (prefers-color-scheme: light){.mini{background:rgba(10,16,36,.03);border:1px solid rgba(10,16,36,.10)}}
    .mini .k{font-size:11px;color:var(--faint);font-family:var(--mono)}
    .mini .v{font-size:13px;margin-top:6px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tag{font-size:11px;padding:6px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--muted);cursor:pointer;user-select:none}
    @media (prefers-color-scheme: light){.tag{background:rgba(10,16,36,.03);border:1px solid rgba(10,16,36,.10)}}
    .tag.active{border-color:rgba(124,92,255,.55);color:var(--text)}
    .ticker{display:flex;gap:12px;align-items:center;overflow:hidden;padding:10px 14px;border-top:1px solid rgba(255,255,255,.10);border-bottom:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)}
    @media (prefers-color-scheme: light){.ticker{border-top:1px solid rgba(10,16,36,.08);border-bottom:1px solid rgba(10,16,36,.08);background:rgba(10,16,36,.02)}}
    .ticker strong{font-size:12px}
    .marq{white-space:nowrap;animation:marq 26s linear infinite;font-size:12px;color:var(--muted)}
    @keyframes marq{0%{transform:translateX(0)}100%{transform:translateX(-55%)}}
    .feed{display:flex;flex-direction:column;gap:10px}
    .story{border-radius:var(--radius);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);overflow:hidden;transition:transform .1s ease,border-color .15s ease,background .15s ease}
    @media (prefers-color-scheme: light){.story{background:rgba(10,16,36,.02);border:1px solid rgba(10,16,36,.10)}}
    .story:hover{transform:translateY(-1px);border-color:rgba(124,92,255,.45)}
    .story .shd{padding:12px 12px 10px;display:flex;gap:10px;align-items:flex-start}
    .badge{font-family:var(--mono);font-size:11px;padding:6px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:var(--muted);white-space:nowrap}
    @media (prefers-color-scheme: light){.badge{background:rgba(10,16,36,.05);border:1px solid rgba(10,16,36,.10)}}
    .badge.breaking{border-color:rgba(255,92,122,.55);color:var(--text)}
    .story h3{margin:0;font-size:13px;line-height:1.25rem}
    .meta{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;font-size:11px;color:var(--faint);font-family:var(--mono)}
    .story .txt{padding:0 12px 12px;color:var(--muted);font-size:12.5px;line-height:1.45rem;max-height:5.3rem;overflow:hidden;position:relative}
    .story .txt:after{content:"";position:absolute;left:0;right:0;bottom:0;height:34px;background:linear-gradient(180deg,transparent,rgba(7,9,15,.95));pointer-events:none}
    @media (prefers-color-scheme: light){.story .txt:after{background:linear-gradient(180deg,transparent,rgba(247,249,255,.96))}}
    .story .actions{padding:10px 12px 12px;display:flex;flex-wrap:wrap;gap:10px;border-top:1px dashed rgba(255,255,255,.14)}
    @media (prefers-color-scheme: light){.story .actions{border-top:1px dashed rgba(10,16,36,.10)}}
    .viewer{height:calc(100vh - 126px);overflow:auto;padding:14px}
    @media (max-width:1200px){.viewer{height:auto;max-height:none}}
    .docTitle{margin:0;font-size:16px}
    .docSub{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4rem}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    @media (prefers-color-scheme: light){.hr{background:rgba(10,16,36,.08)}}
    .content{font-size:13.5px;line-height:1.65rem;color:var(--text)}
    .content pre{overflow:auto;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
    @media (prefers-color-scheme: light){.content pre{background:rgba(10,16,36,.04);border:1px solid rgba(10,16,36,.10)}}
    .content code{font-family:var(--mono)}
    .content blockquote{margin:12px 0;padding:10px 12px;border-left:3px solid rgba(124,92,255,.7);background:rgba(124,92,255,.08);border-radius:12px;color:var(--muted)}
    .kpiRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .kpi{flex:1 1 120px;min-width:140px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);padding:10px}
    @media (prefers-color-scheme: light){.kpi{background:rgba(10,16,36,.03);border:1px solid rgba(10,16,36,.10)}}
    .kpi .n{font-size:18px;font-family:var(--mono)}
    .kpi .l{font-size:11px;color:var(--faint);margin-top:2px}
    .fileList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .fileItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05)}
    @media (prefers-color-scheme: light){.fileItem{background:rgba(10,16,36,.02);border:1px solid rgba(10,16,36,.10)}}
    .fileItem small{color:var(--faint);font-family:var(--mono)}
    .fileItem .left{min-width:0}
    .fileItem .name{font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .fileItem .desc{font-size:11.5px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sep{height:10px}
    .notice{border-radius:16px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:var(--muted);font-size:12px;line-height:1.35rem}
    @media (prefers-color-scheme: light){.notice{background:rgba(10,16,36,.03);border:1px solid rgba(10,16,36,.10)}}
    .notice strong{color:var(--text)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:200;padding:14px}
    .modal.open{display:flex}
    .modal .mcard{width:min(1100px,100%);max-height:92vh;overflow:hidden;border-radius:22px;border:1px solid rgba(255,255,255,.14);background:rgba(12,16,32,.92);backdrop-filter:blur(16px);box-shadow:0 22px 90px rgba(0,0,0,.55)}
    @media (prefers-color-scheme: light){.modal .mcard{background:rgba(255,255,255,.92);border:1px solid rgba(10,16,36,.10)}}
    .modal .mhd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10)}
    @media (prefers-color-scheme: light){.modal .mhd{border-bottom:1px solid rgba(10,16,36,.08)}}
    .modal .mhd .ml{min-width:0}
    .modal .mhd h4{margin:0;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .modal .mhd p{margin:2px 0 0;font-size:11.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .modal .mbd{padding:12px;overflow:auto;max-height:calc(92vh - 56px)}
    iframe.sandbox{width:100%;height:70vh;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:white}
    .tree{font-family:var(--mono);font-size:12px;line-height:1.4rem;color:var(--muted);white-space:pre-wrap;word-break:break-word}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .rightTools{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:11px;color:var(--faint);font-family:var(--mono)}
    input.inline{
      flex:1;min-width:200px;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text)
    }
    @media (prefers-color-scheme: light){
      input.inline{border:1px solid rgba(10,16,36,.12);background:rgba(255,255,255,.65);color:var(--text)}
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand" title="Site statique — dossier documentaire">
      <div class="logo" aria-hidden="true"></div>
      <div style="min-width:0">
        <h1>MEDIA·LIVE — Dossier documentaire</h1>
        <div class="sub">OFFLINE · sans CDN · import multi-fichiers · recherche · viewer</div>
      </div>
    </div>

    <div class="pill"><span class="dot"></span><span id="statusLive">LIVE</span><span class="mono" id="clock"></span></div>

    <div class="search" role="search" aria-label="Recherche">
      <span class="mono" style="opacity:.7">⌕</span>
      <input id="q" placeholder="Rechercher dans le flux, les tags, les pièces jointes…" />
      <kbd title="Raccourci">/</kbd>
    </div>

    <button class="btn primary" id="btnImport">Importer fichiers</button>
    <button class="btn" id="btnReset" title="Réinitialiser les filtres">Reset</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <section class="col card">
    <div class="hd">
      <div class="title">
        <h2>Sommaire du dossier</h2>
        <p>Collections, tags, pièces jointes.</p>
      </div>
      <div class="rightTools">
        <button class="btn" id="btnNewStory" title="Ajouter une entrée">+ Story</button>
        <button class="btn" id="btnExport" title="Exporter le dossier (JSON)">Export</button>
      </div>
    </div>

    <div class="bd">
      <div class="notice">
        <strong>Mode offline :</strong> tout fonctionne sans internet.
        <br><span class="mono">.md</span> rendu “simple”, <span class="mono">.json</span> pretty, <span class="mono">.html</span> sandbox iframe,
        images/pdf preview si possible.
        <br><strong>.docx / .xlsx :</strong> importés et téléchargeables, mais l’aperçu nécessite des libs (optionnel).
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div class="mini">
          <div class="k">Cadre</div>
          <div class="v" id="frameLine">Dossier · Investigation · Sources & pièces jointes</div>
        </div>
        <div class="mini">
          <div class="k">Mode</div>
          <div class="v"><span class="mono" id="modeLine">OFFLINE embarqué</span> <span class="hint">· GitHub Pages OK</span></div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <div class="k">Tags (clique pour filtrer)</div>
        <div class="tags" id="tags"></div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <div class="k">Pièces jointes (locales)</div>
        <div class="fileList" id="fileList"></div>
        <div class="hint" style="margin-top:8px">
          Formats OK offline: .md .txt .json .html .pdf images (preview) + tout autre (download).
        </div>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <div class="k">Embed Spotify (en ligne uniquement)</div>
        <div class="hint">Offline, ça ne s’affichera pas. Sur GitHub Pages, oui.</div>
        <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap">
          <input class="inline" id="spotifyUrl" placeholder="https://open.spotify.com/track/… ou …/playlist/…" />
          <button class="btn" id="btnSpotify">Ajouter embed</button>
        </div>
        <div id="spotifyStack" style="display:flex; flex-direction:column; gap:10px; margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- CENTER -->
  <section class="col card">
    <div class="hd">
      <div class="title">
        <h2>Fil info en continu</h2>
        <p>Entrées datées, “breaking”, sources, pièces jointes.</p>
      </div>
      <div class="rightTools">
        <button class="btn" id="btnSort" title="Inverser l'ordre">Tri</button>
        <button class="btn" id="btnOnlyBreaking" title="Filtrer : Breaking">Breaking</button>
      </div>
    </div>

    <div class="ticker" aria-label="Bandeau live">
      <strong class="mono">FLASH</strong>
      <div class="marq" id="marq">
        • OFFLINE OK • Import fichiers • Recherche • Viewer • Export JSON • Publication GitHub Pages •
      </div>
    </div>

    <div class="bd">
      <div class="feed" id="feed"></div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="col card">
    <div class="hd">
      <div class="title">
        <h2>Lecteur / preuve</h2>
        <p>Affiche story + pièces jointes.</p>
      </div>
      <div class="rightTools">
        <button class="btn" id="btnRedact" title="Masquer infos sensibles (auto)">Redact</button>
        <button class="btn danger" id="btnClearViewer" title="Vider le lecteur">Clear</button>
      </div>
    </div>

    <div class="viewer" id="viewer">
      <h3 class="docTitle" id="docTitle">Bienvenue</h3>
      <p class="docSub" id="docSub">
        Clique <strong>Importer fichiers</strong>, puis <strong>Citer</strong> sur un fichier pour créer une story automatiquement.
      </p>

      <div class="kpiRow" id="kpiRow">
        <div class="kpi"><div class="n" id="kStories">0</div><div class="l">stories</div></div>
        <div class="kpi"><div class="n" id="kFiles">0</div><div class="l">fichiers importés</div></div>
        <div class="kpi"><div class="n" id="kTags">0</div><div class="l">tags</div></div>
      </div>

      <div class="hr"></div>

      <div class="content" id="content">
        <p class="muted">Astuce : tout marche offline. Les previews DOCX/XLSX demandent des libs (optionnel).</p>
        <blockquote>Raccourci recherche : touche <span class="mono">/</span></blockquote>
      </div>
    </div>
  </section>
</div>

<input id="fileInput" type="file" multiple hidden
       accept=".md,.markdown,.json,.xlsx,.xls,.docx,.html,.htm,.txt,.pdf,image/*"/>

<div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Lecteur de pièce jointe">
  <div class="mcard">
    <div class="mhd">
      <div class="ml">
        <h4 id="mTitle">Pièce jointe</h4>
        <p id="mSub">—</p>
      </div>
      <div style="display:flex; gap:10px">
        <button class="btn" id="mDownload">Télécharger</button>
        <button class="btn danger" id="mClose">Fermer</button>
      </div>
    </div>
    <div class="mbd" id="mBody"></div>
  </div>
</div>

<script>
/* =========================
   OFFLINE WORKING CORE
   - no external libs
   - md render: simple
   - json pretty
   - html sandbox
   - images/pdf preview when possible
   - docx/xlsx: download + notice (still "works")
========================= */

(function(){
  const state = {
    descending:true,
    onlyBreaking:false,
    activeTag:null,
    query:"",
    files:[],
    stories:[],
    spotify:[]
  };

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

  // Clock
  setInterval(()=>{
    $("#clock").textContent = new Date().toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }, 250);

  // Seed
  seed();
  rebuild();

  // Bind
  $("#btnImport").addEventListener("click", ()=> $("#fileInput").click());
  $("#fileInput").addEventListener("change", onFiles);
  $("#btnReset").addEventListener("click", resetFilters);
  $("#btnSort").addEventListener("click", ()=>{ state.descending=!state.descending; rebuild(); toast(state.descending?"Tri: récent → ancien":"Tri: ancien → récent"); });
  $("#btnOnlyBreaking").addEventListener("click", ()=>{
    state.onlyBreaking=!state.onlyBreaking;
    $("#btnOnlyBreaking").classList.toggle("primary", state.onlyBreaking);
    rebuild();
  });
  $("#btnClearViewer").addEventListener("click", clearViewer);
  $("#btnRedact").addEventListener("click", redactViewer);
  $("#btnNewStory").addEventListener("click", newStory);
  $("#btnExport").addEventListener("click", exportJSON);

  $("#q").addEventListener("input", ()=>{
    state.query = $("#q").value.trim();
    rebuild();
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "/" && document.activeElement !== $("#q")){
      e.preventDefault();
      $("#q").focus();
    }
    if(e.key==="Escape") closeModal();
  });

  // Modal
  const modal = $("#modal");
  $("#mClose").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

  // Spotify (online)
  $("#btnSpotify").addEventListener("click", ()=>{
    const url = ($("#spotifyUrl").value||"").trim();
    if(!url) return;
    state.spotify.unshift({id:uid(), url});
    $("#spotifyUrl").value="";
    renderSpotify();
  });

  async function onFiles(e){
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;

    for(const file of files){
      const f = await ingestFile(file);
      state.files.unshift(f);
    }
    $("#fileInput").value = "";
    rebuild();
    toast(`Importés: ${files.length} fichier(s).`);
  }

  async function ingestFile(file){
    const id = uid();
    const ext = extOf(file.name);
    const base = {id, name:file.name, type:file.type||"", size:file.size||0, file, ext, kind:"bin"};
    try{
      if(ext==="md" || ext==="markdown" || ext==="txt"){
        const text = await file.text();
        return {...base, text, kind:"text"};
      }
      if(ext==="json"){
        const text = await file.text();
        let json=null;
        try{ json = JSON.parse(text); }catch{}
        return {...base, text, json, kind:"json"};
      }
      if(ext==="html" || ext==="htm"){
        const text = await file.text();
        return {...base, text, kind:"html"};
      }
      if(ext==="pdf"){
        return {...base, kind:"pdf"};
      }
      if((base.type||"").startsWith("image/")){
        return {...base, kind:"img"};
      }
      if(ext==="docx"){
        // offline: no mammoth => still importable/downloadable
        return {...base, kind:"docx"};
      }
      if(ext==="xlsx" || ext==="xls"){
        // offline: no sheetjs => still importable/downloadable
        return {...base, kind:"xlsx"};
      }
      return base;
    }catch(err){
      return {...base, kind:"bin", error:String(err)};
    }
  }

  function rebuild(){
    renderTags();
    renderFiles();
    renderFeed();
    renderKPIs();
    renderSpotify();
  }

  function renderKPIs(){
    $("#kStories").textContent = state.stories.length;
    $("#kFiles").textContent = state.files.length;
    $("#kTags").textContent = uniqueTags().length;
  }

  function uniqueTags(){
    const set = new Set();
    for(const s of state.stories) for(const t of (s.tags||[])) set.add(t);
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  function renderTags(){
    const host = $("#tags");
    host.innerHTML = "";

    const all = mk("span", {class:"tag"+(state.activeTag===null?" active":"")}, "Tous");
    all.addEventListener("click", ()=>{ state.activeTag=null; rebuild(); });
    host.appendChild(all);

    for(const t of uniqueTags()){
      const el = mk("span",{class:"tag"+(state.activeTag===t?" active":"")}, t);
      el.addEventListener("click", ()=>{ state.activeTag = (state.activeTag===t?null:t); rebuild(); });
      host.appendChild(el);
    }
  }

  function renderFiles(){
    const host = $("#fileList");
    host.innerHTML = "";
    if(state.files.length===0){
      host.innerHTML = `<div class="notice">Aucun fichier importé. Clique <strong>Importer fichiers</strong>.</div>`;
      return;
    }
    for(const f of state.files){
      const row = mk("div",{class:"fileItem"});
      row.innerHTML = `
        <div class="left" style="min-width:0">
          <div class="name">${esc(f.name)}</div>
          <div class="desc">${esc(f.type||"application/octet-stream")} · <small>${esc(formatBytes(f.size))} · .${esc(f.ext||"?")}</small></div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
          <button class="btn" data-open="${f.id}">Ouvrir</button>
          <button class="btn" data-link="${f.id}">Citer</button>
        </div>
      `;
      row.querySelector('[data-open]').addEventListener("click", ()=> openFileModal(f.id));
      row.querySelector('[data-link]').addEventListener("click", ()=> makeStoryFromFile(f.id));
      host.appendChild(row);
    }
  }

  function storyMatches(s){
    if(state.onlyBreaking && !s.breaking) return false;
    if(state.activeTag && !(s.tags||[]).includes(state.activeTag)) return false;
    if(state.query){
      const q = state.query.toLowerCase();
      const blob = [
        s.title, s.body,
        (s.tags||[]).join(" "),
        (s.sources||[]).join(" "),
        (s.attachments||[]).join(" ")
      ].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  }

  function renderFeed(){
    const host = $("#feed");
    host.innerHTML = "";

    const list = state.stories
      .slice()
      .sort((a,b)=> state.descending ? (b.ts-a.ts) : (a.ts-b.ts))
      .filter(storyMatches);

    if(list.length===0){
      host.innerHTML = `<div class="notice"><strong>Aucun résultat.</strong> Ajuste recherche/tags ou désactive les filtres.</div>`;
      return;
    }

    for(const s of list){
      const el = mk("article",{class:"story"});
      el.innerHTML = `
        <div class="shd">
          <span class="badge ${s.breaking ? "breaking":""}">${s.breaking ? "BREAKING" : "INFO"}</span>
          <div style="min-width:0; flex:1">
            <h3>${esc(s.title)}</h3>
            <div class="meta">
              <span>${esc(fmtDate(s.ts))}</span>
              <span>·</span>
              <span>${esc((s.tags||[]).slice(0,5).join(", ") || "sans tags")}</span>
              ${(s.attachments||[]).length ? `<span>·</span><span>${(s.attachments||[]).length} pièce(s)</span>` : ""}
              ${(s.sources||[]).length ? `<span>·</span><span>${(s.sources||[]).length} source(s)</span>` : ""}
            </div>
          </div>
        </div>
        <div class="txt">${esc(s.body || "")}</div>
        <div class="actions">
          <button class="btn" data-read="${s.id}">Lire</button>
          <button class="btn" data-attach="${s.id}">Pièces</button>
          <button class="btn" data-src="${s.id}">Sources</button>
          <button class="btn" data-pin="${s.id}">Épingler</button>
        </div>
      `;
      el.querySelector('[data-read]').addEventListener("click", ()=> viewStory(s.id));
      el.querySelector('[data-attach]').addEventListener("click", ()=> openAttachments(s.id));
      el.querySelector('[data-src]').addEventListener("click", ()=> openSources(s.id));
      el.querySelector('[data-pin]').addEventListener("click", ()=> pinToMarquee(s));
      host.appendChild(el);
    }
  }

  function viewStory(id){
    const s = state.stories.find(x=>x.id===id);
    if(!s) return;

    $("#docTitle").textContent = s.title;
    $("#docSub").textContent = `${fmtDate(s.ts)} · ${s.breaking ? "BREAKING" : "INFO"} · tags: ${(s.tags||[]).join(", ") || "—"}`;

    const attachments = (s.attachments||[]).map(fid=>{
      const f = state.files.find(ff=>ff.id===fid);
      if(!f) return "";
      return `<li><a href="#" data-openfile="${fid}">${esc(f.name)}</a> <span class="muted mono">(.${esc(f.ext)})</span></li>`;
    }).join("");

    const sources = (s.sources||[]).map(u=>{
      const safe = esc(u);
      return `<li><a href="${safe}" target="_blank" rel="noopener noreferrer">${safe}</a></li>`;
    }).join("");

    $("#content").innerHTML = `
      <div class="notice"><strong>Offline render :</strong> Markdown rendu simple (titres/listes/code). Les liens externes s’ouvrent dans un nouvel onglet.</div>
      <div class="hr"></div>
      <div class="content">${renderSimpleMarkdown(s.body || "")}</div>
      <div class="hr"></div>
      <div class="mini">
        <div class="k">Pièces jointes</div>
        ${attachments ? `<ul>${attachments}</ul>` : `<p class="muted">Aucune pièce jointe liée.</p>`}
      </div>
      <div class="sep"></div>
      <div class="mini">
        <div class="k">Sources</div>
        ${sources ? `<ul>${sources}</ul>` : `<p class="muted">Aucune source.</p>`}
      </div>
    `;

    $$("#content [data-openfile]").forEach(a=>{
      a.addEventListener("click", (e)=>{ e.preventDefault(); openFileModal(a.getAttribute("data-openfile")); });
    });
  }

  function openAttachments(storyId){
    const s = state.stories.find(x=>x.id===storyId);
    if(!s) return;
    if(!(s.attachments||[]).length){ toast("Aucune pièce jointe liée."); return; }

    $("#docTitle").textContent = "Pièces jointes";
    $("#docSub").textContent = `${s.title} · ${fmtDate(s.ts)}`;

    $("#content").innerHTML = `
      <div class="notice"><strong>Pièces jointes</strong> — clique pour ouvrir.</div>
      <div class="sep"></div>
      <div class="fileList">
        ${(s.attachments||[]).map(fid=>{
          const f = state.files.find(ff=>ff.id===fid);
          if(!f) return "";
          return `
            <div class="fileItem">
              <div class="left" style="min-width:0">
                <div class="name">${esc(f.name)}</div>
                <div class="desc">${esc(f.type||"")} · <small>${esc(formatBytes(f.size))} · .${esc(f.ext)}</small></div>
              </div>
              <div><button class="btn" data-openfile="${fid}">Ouvrir</button></div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    $$("#content [data-openfile]").forEach(b=>{
      b.addEventListener("click", ()=> openFileModal(b.getAttribute("data-openfile")));
    });
  }

  function openSources(storyId){
    const s = state.stories.find(x=>x.id===storyId);
    if(!s) return;

    $("#docTitle").textContent = "Sources";
    $("#docSub").textContent = `${s.title} · ${fmtDate(s.ts)}`;

    const sources = (s.sources||[]);
    $("#content").innerHTML = `
      <div class="notice"><strong>Sources</strong> — liens externes.</div>
      <div class="sep"></div>
      <div class="content">
        ${sources.length ? `<ul>${sources.map(u=>`<li><a href="${esc(u)}" target="_blank" rel="noopener noreferrer">${esc(u)}</a></li>`).join("")}</ul>` : `<p class="muted">Aucune source.</p>`}
      </div>
    `;
  }

  function pinToMarquee(s){
    const seg = `• ${s.breaking ? "BREAKING" : "INFO"} — ${s.title} (${fmtTime(s.ts)}) `;
    const m = $("#marq");
    m.textContent = (seg + " " + m.textContent).slice(0, 800);
    toast("Épinglé dans le bandeau FLASH.");
  }

  function makeStoryFromFile(fileId){
    const f = state.files.find(x=>x.id===fileId);
    if(!f) return;
    const s = {
      id: uid(),
      ts: Date.now(),
      title: `Pièce jointe: ${f.name}`,
      body:
`Résumé / contexte (à compléter).

- Fichier: **${f.name}**
- Type: \`${f.type || "n/a"}\`
- Taille: \`${formatBytes(f.size)}\`

> Clique “Pièces” pour ouvrir la preuve.`,
      tags: ["pièce-jointe", f.ext || "fichier"],
      breaking: false,
      sources: [],
      attachments: [f.id]
    };
    state.stories.unshift(s);
    rebuild();
    viewStory(s.id);
    toast("Story créée depuis la pièce jointe.");
  }

  function resetFilters(){
    state.activeTag=null;
    state.onlyBreaking=false;
    state.query="";
    $("#q").value="";
    rebuild();
    toast("Filtres réinitialisés.");
  }

  function clearViewer(){
    $("#docTitle").textContent = "Lecteur vidé";
    $("#docSub").textContent = "—";
    $("#content").innerHTML = `<p class="muted">Sélectionne une story ou ouvre une pièce jointe.</p>`;
  }

  function redactViewer(){
    const el = $("#content");
    const txt = el.innerText || "";
    const red = redactText(txt);
    el.innerHTML = `<div class="notice"><strong>Redact appliqué</strong> (best effort).</div><div class="sep"></div><pre class="tree">${esc(red)}</pre>`;
    toast("Redact appliqué.");
  }

  function exportJSON(){
    const payload = {
      exportedAt: new Date().toISOString(),
      stories: state.stories,
      spotify: state.spotify,
      files: state.files.map(f=>({id:f.id,name:f.name,type:f.type,size:f.size,ext:f.ext,kind:f.kind}))
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="dossier-export.json";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);
    toast("Export JSON téléchargé.");
  }

  function newStory(){
    const title = prompt("Titre de la story :", "Nouvelle story");
    if(!title) return;
    const tags = prompt("Tags (séparés par des virgules) :", "analyse, dossier");
    const breaking = confirm("Marquer en BREAKING ?");
    const body = prompt("Texte (Markdown simple) :", "Résumé + contexte + liens + pièces jointes…");
    const s = {
      id: uid(),
      ts: Date.now(),
      title: title.trim(),
      body: body || "",
      tags: (tags||"").split(",").map(x=>x.trim()).filter(Boolean),
      breaking,
      sources: [],
      attachments: []
    };
    state.stories.unshift(s);
    rebuild();
    viewStory(s.id);
  }

  // ===== Modal file viewer (OFFLINE) =====
  function openFileModal(fileId){
    const f = state.files.find(x=>x.id===fileId);
    if(!f) return;

    $("#mTitle").textContent = f.name;
    $("#mSub").textContent = `${f.type || "—"} · ${formatBytes(f.size)} · .${f.ext}`;

    $("#mDownload").onclick = ()=>{
      const url = URL.createObjectURL(f.file);
      const a = document.createElement("a");
      a.href=url; a.download=f.name;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
    };

    const body = $("#mBody");
    body.innerHTML = "";

    if(f.kind==="text"){
      body.innerHTML = `<div class="content">${renderSimpleMarkdown(f.text || "")}</div>`;
    } else if(f.kind==="json"){
      const txt = (f.text || "");
      const pretty = (()=>{ try{ return JSON.stringify(JSON.parse(txt), null, 2); }catch{ return txt; } })();
      body.innerHTML = `<div class="notice"><strong>JSON</strong> — aperçu.</div><div class="sep"></div><pre class="tree">${esc(pretty)}</pre>`;
    } else if(f.kind==="html"){
      const blob = new Blob([f.text||""], {type:"text/html"});
      const url = URL.createObjectURL(blob);
      body.innerHTML = `
        <div class="notice"><strong>HTML</strong> — sandbox iframe.</div>
        <div class="sep"></div>
        <iframe class="sandbox" sandbox="allow-scripts allow-forms allow-popups allow-modals allow-downloads"
                referrerpolicy="no-referrer" src="${url}"></iframe>
      `;
    } else if(f.kind==="img"){
      const url = URL.createObjectURL(f.file);
      body.innerHTML = `<img src="${url}" alt="${esc(f.name)}" style="max-width:100%;border-radius:18px;border:1px solid rgba(255,255,255,.12)"/>`;
    } else if(f.kind==="pdf"){
      const url = URL.createObjectURL(f.file);
      body.innerHTML = `<iframe class="sandbox" src="${url}" sandbox="allow-same-origin allow-scripts"></iframe>`;
    } else if(f.kind==="docx"){
      body.innerHTML = `<div class="notice">
        <strong>DOCX</strong> importé. Aperçu offline indisponible sans lib. Utilise <strong>Télécharger</strong>.
      </div>`;
    } else if(f.kind==="xlsx"){
      body.innerHTML = `<div class="notice">
        <strong>XLSX</strong> importé. Aperçu offline indisponible sans lib. Utilise <strong>Télécharger</strong>.
      </div>`;
    } else {
      body.innerHTML = `<div class="notice"><strong>Fichier</strong> — téléchargement conseillé.</div>`;
    }

    $("#modal").classList.add("open");
  }

  function closeModal(){
    $("#modal").classList.remove("open");
    $("#mBody").innerHTML = "";
    $("#mDownload").onclick = null;
  }

  // ===== Spotify (online) =====
  function renderSpotify(){
    const host = $("#spotifyStack");
    host.innerHTML = "";
    for(const s of state.spotify){
      const src = spotifyEmbedSrc(s.url);
      const box = mk("div",{class:"mini"});
      box.innerHTML = `
        <div class="k">Spotify</div>
        <div class="sep"></div>
        ${src ? `<iframe style="border-radius:16px" src="${esc(src)}" width="100%" height="152" frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`
          : `<div class="notice">URL Spotify non reconnue.</div>`}
        <div class="sep"></div>
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
          <div class="hint mono" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.url)}</div>
          <button class="btn danger" data-del="${s.id}">Supprimer</button>
        </div>
      `;
      box.querySelector('[data-del]').addEventListener("click", ()=>{
        state.spotify = state.spotify.filter(x=>x.id!==s.id);
        renderSpotify();
      });
      host.appendChild(box);
    }
  }

  function spotifyEmbedSrc(url){
    try{
      const u = new URL(url);
      if(u.hostname.includes("open.spotify.com")){
        if(u.pathname.startsWith("/embed/")) return url;
        const parts = u.pathname.split("/").filter(Boolean);
        if(parts.length>=2){
          return `https://open.spotify.com/embed/${parts[0]}/${parts[1]}`;
        }
      }
    }catch{}
    return null;
  }

  // ===== helpers =====
  function seed(){
    state.stories = [
      {
        id:uid(),
        ts:Date.now()-1000*60*18,
        title:"Brief — Dossier offline opérationnel",
        body:
`# Objectif
Dossier documentaire **statique** qui imite un média live.

## Offline
- Tout l’interactif fonctionne sans internet.
- Les previews **DOCX/XLSX** demandent des libs optionnelles (sinon download).

> Importe tes fichiers puis clique **Citer**.`,
        tags:["cadre","offline","méthodo"],
        breaking:false,
        sources:[],
        attachments:[]
      },
      {
        id:uid(),
        ts:Date.now()-1000*60*6,
        title:"Breaking — Prêt pour import",
        body:
`Clique **Importer fichiers** et ajoute : .md .json .html .pdf images.
DOCX/XLSX : import + download OK.`,
        tags:["breaking","workflow"],
        breaking:true,
        sources:[],
        attachments:[]
      }
    ];
  }

  function fmtTime(ts){
    const d=new Date(ts); const pad=n=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function fmtDate(ts){
    const d=new Date(ts);
    return d.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }
  function extOf(name){
    const i=name.lastIndexOf(".");
    return i>=0 ? name.slice(i+1).toLowerCase() : "";
  }
  function formatBytes(bytes){
    const u=["B","KB","MB","GB"]; let b=bytes||0, i=0;
    while(b>=1024 && i<u.length-1){ b/=1024; i++; }
    return `${b.toFixed(i?1:0)} ${u[i]}`;
  }
  function mk(tag, attrs, text){
    const el=document.createElement(tag);
    if(attrs) for(const k of Object.keys(attrs)) el.setAttribute(k, attrs[k]);
    if(text!=null) el.textContent=text;
    return el;
  }
  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function redactText(text){
    let t = String(text||"");
    t = t.replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig, "[email masqué]");
    t = t.replace(/\b(\+?\d[\d\s().-]{7,}\d)\b/g, "[numéro masqué]");
    return t;
  }

  // Simple markdown renderer (offline, safe):
  // - headings (#, ##, ###)
  // - unordered lists (-, *)
  // - code fences ``` ```
  // - inline code ``
  // - blockquotes >
  // - blank lines -> <p>
  function renderSimpleMarkdown(md){
    const lines = String(md||"").replace(/\r\n/g,"\n").split("\n");
    let html = "";
    let inCode = false;
    let codeBuf = [];
    let inList = false;

    const flushList = ()=>{
      if(inList){ html += "</ul>"; inList=false; }
    };
    const flushCode = ()=>{
      if(inCode){
        html += `<pre><code>${esc(codeBuf.join("\n"))}</code></pre>`;
        inCode=false; codeBuf=[];
      }
    };

    for(let i=0;i<lines.length;i++){
      const line = lines[i];

      if(line.trim().startsWith("```")){
        if(inCode){ flushCode(); }
        else { flushList(); inCode=true; codeBuf=[]; }
        continue;
      }

      if(inCode){
        codeBuf.push(line);
        continue;
      }

      // headings
      const mH = line.match(/^(#{1,3})\s+(.*)$/);
      if(mH){
        flushList();
        const level = mH[1].length;
        const content = inlineFormat(mH[2]);
        html += `<h${level}>${content}</h${level}>`;
        continue;
      }

      // blockquote
      const mQ = line.match(/^>\s?(.*)$/);
      if(mQ){
        flushList();
        html += `<blockquote>${inlineFormat(mQ[1])}</blockquote>`;
        continue;
      }

      // list items
      const mL = line.match(/^(\-|\*)\s+(.*)$/);
      if(mL){
        if(!inList){ html += "<ul>"; inList=true; }
        html += `<li>${inlineFormat(mL[2])}</li>`;
        continue;
      } else {
        flushList();
      }

      // empty line
      if(line.trim()===""){
        html += "";
        continue;
      }

      // paragraph
      html += `<p>${inlineFormat(line)}</p>`;
    }

    flushList();
    flushCode();
    return html;
  }

  function inlineFormat(text){
    // inline code: `...`
    let t = esc(text);
    t = t.replace(/`([^`]+)`/g, (m,g1)=>`<code>${esc(g1)}</code>`);
    // bold **...**
    t = t.replace(/\*\*([^*]+)\*\*/g, (m,g1)=>`<strong>${esc(g1)}</strong>`);
    // italic *...*
    t = t.replace(/\*([^*]+)\*/g, (m,g1)=>`<em>${esc(g1)}</em>`);
    // links [text](url)
    t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m,txt,url)=>`<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(txt)}</a>`);
    return t;
  }

  function toast(msg){
    const n = document.createElement("div");
    n.textContent = msg;
    n.style.position="fixed";
    n.style.left="50%";
    n.style.bottom="16px";
    n.style.transform="translateX(-50%)";
    n.style.padding="10px 12px";
    n.style.borderRadius="14px";
    n.style.background="rgba(10,14,26,.82)";
    n.style.border="1px solid rgba(255,255,255,.12)";
    n.style.boxShadow="0 18px 60px rgba(0,0,0,.45)";
    n.style.color="var(--text)";
    n.style.fontSize="12px";
    n.style.zIndex="500";
    n.style.backdropFilter="blur(12px)";
    document.body.appendChild(n);
    setTimeout(()=>{ n.style.opacity="0"; n.style.transition="opacity .25s ease"; }, 1400);
    setTimeout(()=> n.remove(), 1750);
  }
})();
</script>
</body>
</html>
